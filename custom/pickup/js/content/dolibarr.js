(()=>{"use strict";var n,t="/custom/pickup/pickup_printable_label.php";function e(n,t){var e="get"in n?n.get(0):n;if(e){var r,a=document.createElement("iframe");a.setAttribute("src",t),a.style.display="none";var i=!1;e.classList.contains("btn")?((r=document.createElement("span")).classList.add("spinner-border"),r.classList.add("spinner-border-sm"),n.prepend(r)):e.classList.contains("button")&&(i=!0,e.classList.add("disabled")),e.after(a),a.onload=function(){var n;null===(n=a.contentWindow)||void 0===n||n.print(),null==r||r.remove(),i&&e.classList.remove("disabled")}}}function r(t,e){if(!n)throw new Error("DolibarrPickup base url is not set");var r=new URL(t,document.location.origin+n);if(null===e)return r.toString();for(var a in e){var i=e[a];r.searchParams.set(a,i)}return r.toString()}var a=function(n,t,e,r){return new(e||(e=Promise))((function(a,i){function o(n){try{l(r.next(n))}catch(n){i(n)}}function c(n){try{l(r.throw(n))}catch(n){i(n)}}function l(n){var t;n.done?a(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(o,c)}l((r=r.apply(n,t||[])).next())}))},i=function(n,t){var e,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;o;)try{if(e=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!((a=(a=o.trys).length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(n,o)}catch(n){i=[6,n],r=0}finally{e=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}};function o(n){return a(this,void 0,void 0,(function(){var t,e,a;return i(this,(function(i){switch(i.label){case 0:return t=r("mobile_data.php",{action:"generate",key:"batchnumber",product_id:n}),[4,fetch(t,{method:"GET",cache:"no-cache"})];case 1:return e=i.sent(),(a=e.headers.get("content-type"))&&a.includes("application/json")?[4,e.json()]:[2,null];case 2:return[2,i.sent().batch_number]}}))}))}var c=new Map,l=new Map,s=new Map,u=new Map,d=new Map;function p(n,t){for(var e,r,a=0,i=t;a<i.length;a++){var o=i[a];if(0!==(r=n.find("input[name^=batchl][value="+o.toString()+"]").first().closest("tr")).length)break}if(!(null==r?void 0:r.length))return null;var c=r.find("input[name^=qtyl]").first(),l=parseInt(null!==(e=c.val())&&void 0!==e?e:0);if(!c.length)return null;var s=c.attr("name"),u=null==s?void 0:s.match(/^qtyl(\d+)(_\d+)?$/);if(!u)return null;var d=parseInt(u[1]),p=parseInt(n.find("#qtyasked"+d.toString()).val()||"0"),f=parseInt(n.find("#qtydelivered"+d.toString()).val()||"0");return{indiceAsked:d,qtyAsked:p,qtyDelivered:f,qty:l,tr:r,qtyInput:c}}window.dolibarrPickup={setBaseUrl:function(e){n=e,console.log("Base url is set to:",e),function(n){t=n}(r("pickup_printable_label.php"))},printProductLabel:function(n,r){var a=new URL(t,window.location.origin);a.searchParams.set("what","product"),a.searchParams.set("product_id[]",r),e(n,a.toString())},printPickupLabels:function(n,r){var a=new URL(t,window.location.origin);a.searchParams.set("what","pickup"),a.searchParams.set("pickup_id[]",r),e(n,a.toString())},printPickupLineLabels:function(n,r){var a=new URL(t,window.location.origin);a.searchParams.set("what","pickupline"),a.searchParams.set("pickupline_id[]",r),e(n,a.toString())},printProductLotLabel:function(n,r){var a=new URL(t,window.location.origin);a.searchParams.set("what","product_lot"),Array.isArray(r)?(a.searchParams.delete("productlot_id[]"),r.forEach((function(n){return a.searchParams.append("productlot_id[]",n)}))):a.searchParams.set("productlot_id[]",r),e(n,a.toString())},enhanceStockTransferForm:function(n,t,e){console.log("Entering enhanceStockTransferForm..."),document.querySelectorAll("input[name=batch_number]:not(disabled)").forEach((function(n){console.log("enhanceStockTransferForm: found a batch_number input");var e=n;e.value?console.log("enhanceStockTransferForm: input is not empty, skipping"):function(n,t){var e=this,r=document.createElement("a");r.classList.add("button"),r.classList.add("buttongen"),r.innerHTML="&larr;Générer",r.title="Générer un numéro de lot/série",r.onclick=function(){return a(e,void 0,void 0,(function(){var e,r;return i(this,(function(a){switch(a.label){case 0:return e=n,[4,o(t)];case 1:return e.value=null!==(r=a.sent())&&void 0!==r?r:"",[2]}}))}))},n.after(r)}(e,t)})),e&&(console.log("enhanceStockTransferForm: batch must be unique, settings nbpiece to 1 by default"),document.querySelectorAll("input[name=nbpiece]:not(disabled)").forEach((function(n){"value"in n&&(n.value||(n.value="1"))})))},addScanLabelsToExpeditionForm:function(n){c.clear(),l.clear(),s.clear(),u.clear(),d.clear(),$((function(){var t=function(n){return n?$(n).closest("table"):null}(n);if(t&&t.length){var e=$("\n    <label>\n      Scannez les étiquettes pour sélectionner les lots.\n      <textarea></textarea>\n    </label>\n  ");e.find("textarea").on("keyup",(function(n){"Enter"===n.key&&function(n,t){for(var e,r=0,a=(null!==(e=t.val())&&void 0!==e?e:"").toString().split(/\n|\r/).map((function(n){return n.trim()})).filter((function(n){return""!==n}));r<a.length;r++){var i=a[r];if(!d.has(i)){d.set(i,!0);var o=c.get(i);if(o){var l=p(n,o);if(console.log("Scan pour "+i,l),l){u.has(l.indiceAsked)||(n.find("input[name=qtyl"+l.indiceAsked.toString()+"], input[name^=qtyl"+l.indiceAsked.toString()+"_]").val(0),u.set(l.indiceAsked,!0));var f="2"===s.get(i)?1:Math.max(1,l.qtyAsked-l.qtyDelivered);l.qtyInput.val(f)}}}}}(t,$(this))})),t.before(e)}}))},fillBatchInfos:function(n){for(var t in n){c.set(t,n[t].productBatchId);for(var e=0,r=n[t].productBatchId;e<r.length;e++){var a=r[e];l.set(a,t)}s.set(t,n[t].statusBatch)}}}})();
//# sourceMappingURL=dolibarr.js.map